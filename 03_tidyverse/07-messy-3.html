<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
  <head>
    <title>Cleaning data: messy 3</title>
    <meta charset="utf-8" />
    <meta name="author" content="Heike Hofmann" />
    <meta name="date" content="2019-10-11" />
    <link href="libs/remark-css-0.0.1/default.css" rel="stylesheet" />
    <link href="libs/remark-css-0.0.1/default-fonts.css" rel="stylesheet" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Cleaning data: messy 3
### Heike Hofmann
### 2019-10-11

---

class: middle, inverse, center
# Messy (3)


Multiple observational units are stored in the same table.



---

# Keys and Measurements

## Finding your keys - Example (1)

100 patients are randomly assigned to a treatment for heart attack, measured 5 different clinical outcomes.

--

- key: patient ID

- factor variable (design): treatment

- measured variables: 5 clinical outcomes

---

# Finding your keys - Example (2)

Randomized complete block trial with four fields, four different types of fertilizer, over four years.  Recorded total corn yield, and fertilizer run off

--

- key: fields, types of fertilizer, year

- measurement: total corn yield, fertilizer run off

---

# Finding your keys - Example (3)

Cluster sample of twenty students in thirty different schools.  For each school, recorded distance from ice rink.  For each student, asked how often they go ice skating, and whether or not their parents like ice skating


--

- key: student ID, school ID

- measurement: distance to rink, #times ice skating, parents' preference

---

# Finding your keys - Example (4)

For each person, recorded age, sex, height and target weight, and then at multiple times recorded their weight

--

- key: *patient ID*, date

- measurement: *age, sex, height, target weight*, current weight

*only patient ID is needed for variables in italics*

---

# Messy (3)

Messy (3): *Multiple observational units are stored in the same table.*

What does that mean? The *key is split*, i.e. for some values all key variables are necessary, while other values only need some key variables.

![](images/normal-not-2.png)

---

# Why do we need to take care of split keys?

- Data redundancy introduces potential problems (same student *should* have the same student ID)

- to check data consistency, we split data set into parts - this process is called *normalizing*

- normalization reduces overall data size

- useful way of thinking about objects under study

---

# Tidying Messy (3)

Splitting into separate datasets:

![](images/normal-split.png)

---

# Example: Box office gross

The-Numbers website publishes [weekly charts](http://www.the-numbers.com/weekend-box-office-chart) of the gross income of all movies playing across the US. A set of cleaned data called `box` with movies for the last five years is available in the `classdata` package.


```r
# devtools::install_github("heike/classdata")
library(classdata)
head(box, 4)
```

```
##   Rank Rank.Last.Week                   Movie        Distributor    Gross
## 1    1             NA Solo: A Star Wars Story        Walt Disney 84420489
## 2    2              1              Deadpool 2   20th Century Fox 43463043
## 3    3              2  Avengers: Infinity War        Walt Disney 17294657
## 4    4              3               Book Club Paramount Pictures 10071681
##   Change Thtrs. Per Thtr. Total.Gross Week       Date
## 1     NA   4381     19270   0.8442049    1 2018-05-25
## 2    -65   4349      9994   2.0817040    2 2018-05-25
## 3    -41   3768      4590   6.2248930    5 2018-05-25
## 4    -26   2810      3584   0.3227969    2 2018-05-25
##                     Movie-Distributor
## 1 Solo: A Star Wars Story.Walt Disney
## 2         Deadpool 2.20th Century Fox
## 3  Avengers: Infinity War.Walt Disney
## 4        Book Club.Paramount Pictures
```

What are the key variables? Why is the key split?

---

# Keys and measurements

- Key variables: `Movie` name,  `Date` and `Distributor`. 

- Measurement variables: `Gross`, `Thtrs.`

- All other variables are derived from these variables

- good practice: re-calculate the derived variabes to check for consistency. 

---

# Taking care of the split key

Plan: separate movie information from box office information

Idea for separation: we want to get a set of movies together with their Distributor and ideally their release date (which we do not have).

Instead of release date we want to get the date of the first time that we see a movie in the boxoffice.

Let's also keep track of how many weeks a movie has been released at that time (should be 1 - when will it be different for sure?)

---
class: inverse
# Your turn 

For this your turn use the `box` data from the `classdata` package 

- Big goal: we want to create a new dataset `movie` that consists of movie, distributor, date of first time the movie shows up in the box office, and the number of weeks the movie has been released at that time.

- First: what are the key variables for the new dataset?

- Second: for the key variable(s) use `summarize` to find the first time a movie shows up in the box office and find the related number of weeks. 

---

# Key variables 

Does `Movie` uniquely describe a movie?


```r
movies &lt;- box %&gt;% select(Movie, Distributor) %&gt;% unique()
```

Does that make a movie unique?


```r
movies %&gt;% count(Movie) %&gt;% arrange(desc(n))
```

```
## # A tibble: 935 x 2
##    Movie           n
##    &lt;chr&gt;       &lt;int&gt;
##  1 Champion        2
##  2 Gold            2
##  3 Mama Africa     2
##  4 Reset           2
##  5 102 Not Out     1
##  6 12 Days         1
##  7 12 Strong       1
##  8 13 Minutes      1
##  9 1945            1
## 10 2:22            1
## # … with 925 more rows
```

---

# Movie data - take 2


Get the Week info  for the first time we see  each Movie and Distributor combo:


```r
movies &lt;- box %&gt;% group_by(Movie, Distributor) %&gt;% 
  summarise(
    firstDate = Date[which.min(Week)], 
    firstWeek = min(Week, na.rm=TRUE))
head(movies)
```

```
## # A tibble: 6 x 4
## # Groups:   Movie [6]
##   Movie       Distributor            firstDate  firstWeek
##   &lt;chr&gt;       &lt;chr&gt;                  &lt;date&gt;         &lt;dbl&gt;
## 1 102 Not Out Sony Pictures          2018-05-04         1
## 2 12 Days     Distrib Films          2018-03-16         1
## 3 12 Strong   Warner Bros.           2018-01-19         1
## 4 13 Minutes  Sony Pictures Classics 2017-06-30         1
## 5 1945        Menemsha Entertainment 2017-11-03         1
## 6 2:22        Magnolia Pictures      2017-06-30         1
```

---

# Looking into inconsistencies


```r
movies %&gt;% group_by(Movie) %&gt;% mutate(n = n()) %&gt;% arrange(desc(n))
```

```
## # A tibble: 939 x 5
## # Groups:   Movie [935]
##    Movie       Distributor           firstDate  firstWeek     n
##    &lt;chr&gt;       &lt;chr&gt;                 &lt;date&gt;         &lt;dbl&gt; &lt;int&gt;
##  1 Champion    ArtAffects            2017-05-26         2     2
##  2 Champion    Well Go USA           2018-05-11         1     2
##  3 Gold        Sony Pictures         2017-12-01         1     2
##  4 Gold        Weinstein Co.         2017-01-27         1     2
##  5 Mama Africa ""                    2018-01-19       816     2
##  6 Mama Africa ArtMattan Productions 2018-01-19         1     2
##  7 Reset       FilmRise              2017-01-13         1     2
##  8 Reset       Well Go USA           2017-06-30         1     2
##  9 102 Not Out Sony Pictures         2018-05-04         1     1
## 10 12 Days     Distrib Films         2018-03-16         1     1
## # … with 929 more rows
```

---

# Using IMDb

- Girlhood is the name of two movies - one that was released in 2003, one in 2014; most likely the Oct 4 boxoffice mention is only mistakenly referring to the 2003 movie


```r
box %&gt;% filter(Movie=="Girlhood") %&gt;% head(6)
```

```
##  [1] Rank              Rank.Last.Week    Movie            
##  [4] Distributor       Gross             Change           
##  [7] Thtrs.            Per Thtr.         Total.Gross      
## [10] Week              Date              Movie-Distributor
## &lt;0 rows&gt; (or 0-length row.names)
```

---

# Using IMDb (2)

- Mama Africa refers to two movies, one released in 2002, one in 2011; likely the duplicate  on Jan 19 is erroneous, but we still don't know which of the two movies is showing (in 1 theater)


```r
box %&gt;% filter(Movie=="Mama Africa")
```

```
##   Rank Rank.Last.Week       Movie           Distributor Gross Change
## 1   88             79 Mama Africa ArtMattan Productions   481    -72
## 2   79             67 Mama Africa ArtMattan Productions  1689    -52
## 3   67             NA Mama Africa ArtMattan Productions  3495     NA
## 4   69             NA Mama Africa                        3187     NA
##   Thtrs. Per Thtr. Total.Gross Week       Date
## 1      2       241   9.808e-05    3 2018-02-02
## 2      2       845   8.123e-05    2 2018-01-26
## 3      1      3495   3.495e-05    1 2018-01-19
## 4      1      3187   3.187e-05  816 2018-01-19
##                   Movie-Distributor
## 1 Mama Africa.ArtMattan Productions
## 2 Mama Africa.ArtMattan Productions
## 3 Mama Africa.ArtMattan Productions
## 4                      Mama Africa.
```

---

# why do we normalize?

- Normalization helps identify inconsistencies in data

- Checking up on inconsistencies is a lot of manual labor
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();</script>

<script>
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
